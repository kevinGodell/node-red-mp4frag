<script type="text/javascript">
  // add helper functions here

  /*
    register node
   */
  RED.nodes.registerType('ui_mp4frag', {
    align: 'left',
    category: 'cctv',
    color: '#DEBD5C',
    defaults: {
      name: {
        value: '',
      },
      group: {
        type: 'ui_group',
        required: true,
      },
      order: {
        value: 0,
      },
      width: {
        value: 5,
      },
      height: {
        value: 4,
      },
      readyPoster: {
        value: 'https://raw.githubusercontent.com/kevinGodell/node-red-contrib-mp4frag/master/video_playback_ready.png',
      },
      errorPoster: {
        value: 'https://raw.githubusercontent.com/kevinGodell/node-red-contrib-mp4frag/master/video_playback_error.png',
      },
      hlsJsConfig: {
        value: JSON.stringify({
          debug: false,
          liveDurationInfinity: true,
          liveBackBufferLength: 0,
          maxBufferLength: 5, // default 30
          manifestLoadingTimeOut: 1000,
          manifestLoadingMaxRetry: 10,
          manifestLoadingRetryDelay: 500,
        }),
        validate: RED.validators.typedInput('json'),
      },
      restart: {
        value: true,
        validate: RED.validators.typedInput('bool'),
      },
      autoplay: {
        value: true,
        validate: RED.validators.typedInput('bool'),
      },
    },
    icon: 'font-awesome/fa-file-video-o',
    inputLabels: 'widget input',
    inputs: 1,
    label: function () {
      return this.name || 'ui_mp4frag';
    },
    outputLabels: 'widget output',
    outputs: 1,
    oneditprepare: function () {
      $('#node-input-size').elementSizer({
        width: '#node-input-width',
        height: '#node-input-height',
        group: '#node-input-group',
      });

      $('#uiMp4fragHlsJs')
        .val(RED.settings.uiMp4fragHlsJs)
        .on('click', () => {
          RED.notify(
            `Add property <strong>uiMp4fragHlsJs</strong> to <em>settings.js</em><hr/><code class="form-tip form-tips">uiMp4fragHlsJs: 'url-to-lib-hls.js'</code>`,
            'error'
          );
        });

      $('#node-input-autoplay').typedInput({ types: ['bool'] });

      $('#node-input-restart').typedInput({ types: ['bool'] });

      $('#node-input-hlsJsConfig').typedInput({ types: ['json'] });
    },
    oneditsave: function () {},
  });
</script>

<script data-template-name="ui_mp4frag" type="text/html">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name" />
  </div>

  <div class="form-row" id="template-row-group">
    <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
    <input type="text" id="node-input-group" />
  </div>

  <div class="form-row" id="template-row-size">
    <label for="node-input-size"><i class="fa fa-object-group"></i> Size</label>
    <button class="editor-button" id="node-input-size"></button>
    <input type="hidden" id="node-input-width" />
    <input type="hidden" id="node-input-height" />
  </div>

  <div class="form-row">
    <label for="node-input-readyPoster"><i class="fa fa-picture-o"></i> Ready</label>
    <input type="text" id="node-input-readyPoster" />
  </div>

  <div class="form-row">
    <label for="node-input-errorPoster"><i class="fa fa-picture-o"></i> Error</label>
    <input type="text" id="node-input-errorPoster" />
  </div>

  <fieldset>
    <legend>video options</legend>

    <div class="form-row">
      <label for="node-input-autoplay"><i class="fa fa-play"></i> Autoplay</label>
      <input type="text" id="node-input-autoplay" />
    </div>

    <div class="form-row">
      <label for="node-input-restart"><i class="fa fa-repeat"></i> Restart</label>
      <input type="text" id="node-input-restart" />
    </div>
  </fieldset>

  <fieldset>
    <legend>hls.js options</legend>

    <div class="form-row">
      <label for="uiMp4fragHlsJs"><i class="fa fa-book"></i> URL</label>
      <input type="text" id="uiMp4fragHlsJs" readonly />
    </div>

    <div class="form-row">
      <label for="node-input-hlsJsConfig"><i class="fa fa-cog"></i> Config</label>
      <input type="text" id="node-input-hlsJsConfig" />
    </div>
  </fieldset>
</script>

<script data-help-name="ui_mp4frag" type="text/html">
  <p>Play a fragmented mp4.</p>
</script>
